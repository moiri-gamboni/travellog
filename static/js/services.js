// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var srv;

  srv = angular.module("mainModule.services", []);

  srv.factory('test', [
    function() {
      return true;
    }
  ]);

  srv.factory('Country', [
    '$http', '$rootScope', function($http, $rootScope) {
      var factory;
      factory = {
        getCountries: function() {
          return $http.get(window.location.protocol + "//" + window.location.host + "/countries");
        },
        getCountry: function(countryName) {
          return $http.get(window.location.protocol + "//" + window.location.host + "/countries", {
            params: {
              id: countryName
            }
          });
        },
        loadCountry: function(fileIds, countryName, countryIndex) {
          var fileId, i, _i, _ref;
          this.data = {
            countryIndex: countryIndex,
            fileIds: fileIds,
            countryName: countryName,
            loadedLogs: [],
            logInit: fileIds.length < 3 ? fileIds.length : 3
          };
          console.log("countryIndex for " + this.data.countryName + " : " + this.data.countryIndex);
          $rootScope.$broadcast('country-init');
          this.loadLog = function(fileId) {
            var callback,
              _this = this;
            callback = function(countryData) {
              return function(data, status, headers, config) {
                countryData.loadedLogs.push(data.log);
                countryData.fileIds.pop();
                countryData.logInit--;
                if (countryData.logInit === 0) {
                  console.log("logInit DONE for " + countryData.countryName);
                  console.log(countryData.loadedLogs);
                  return $rootScope.$broadcast('country-finished-init', countryData.countryIndex);
                }
              };
            };
            return $http.get(window.location.protocol + "//" + window.location.host + "/logs", {
              params: {
                id: fileId
              }
            }).success(callback(this.data));
          };
          this.getLog = function() {
            var log;
            console.log("getLog");
            console.log(this.data.loadedLogs.length);
            if (this.data.loadedLogs.length !== 0) {
              log = this.data.loadedLogs.pop();
              return log;
            } else if (this.data.fileIds.length !== 0) {
              return 1;
            } else {
              return 0;
            }
          };
          for (i = _i = 1, _ref = this.data.logInit; 1 <= _ref ? _i <= _ref : _i >= _ref; i = 1 <= _ref ? ++_i : --_i) {
            fileId = this.data.fileIds[this.data.fileIds.length - i];
            this.loadLog(fileId);
          }
          return this;
        }
      };
      return factory;
    }
  ]);

  srv.factory('Map', [
    '$rootScope', 'Country', function($rootScope, Country) {
      var service, shuffle;
      shuffle = function(array) {
        temp;
        index;
        var counter, index, temp;
        counter = array.length;
        while (counter--) {
          index = (Math.random() * counter) | 0;
          temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
          return array;
        }
      };
      service = {
        availableCountries: [],
        loadedCountries: [],
        current: [],
        map: [],
        countryIndex: 0
      };
      Country.getCountries().success(function(data, status, headers, config) {
        var callback, countries, current, i, _i, _results,
          _this = this;
        service.availableCountries = shuffle(data.countries);
        current = [100, 100];
        $rootScope.$on('country-init', function(event) {
          return service.countryIndex++;
        });
        $rootScope.$on('country-finished-init', function(event, countryIndex) {
          var i, log, _i, _results;
          console.log(countryIndex);
          _results = [];
          for (i = _i = -1; _i <= 1; i = ++_i) {
            log = service.loadedCountries[countryIndex].getLog();
            console.log(log);
            if (service.map[100 + countryIndex] == null) {
              service.map[100 + countryIndex] = [];
            }
            _results.push(service.map[100 + countryIndex][100 + i] = log);
          }
          return _results;
        });
        _results = [];
        for (i = _i = 1; _i <= 3; i = ++_i) {
          countries = data.countries;
          callback = function(i) {
            var _this = this;
            return function(data, status, headers, config) {
              var country;
              country = countries[countries.length - i];
              return service.loadedCountries.push(Country.loadCountry(data.logs, country, service.countryIndex));
            };
          };
          _results.push(Country.getCountry(data.countries[data.countries.length - i]).success(callback(i)).error(function(data, status, headers, config) {
            return console.log(data);
          }));
        }
        return _results;
      });
      return service;
    }
  ]);

}).call(this);

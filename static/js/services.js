// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var srv;

  srv = angular.module("mainModule.services", []);

  srv.factory('test', [
    function() {
      return true;
    }
  ]);

  srv.factory('Country', [
    '$http', '$rootScope', function($http, $rootScope) {
      var factory;
      factory = {
        getCountries: function() {
          return $http.get(window.location.protocol + "//" + window.location.host + "/countries");
        },
        getCountry: function(countryName) {
          return $http.get(window.location.protocol + "//" + window.location.host + "/countries", {
            params: {
              id: countryName
            }
          });
        },
        loadCountry: function(fileIds, countryName, countryIndex) {
          var i, _i;
          this.countryIndex = countryIndex;
          $rootScope.$broadcast('country-init');
          this.fileIds = fileIds;
          this.countryName = countryName;
          this.loadedLogs = [];
          this.logInit = fileIds.length < 3 ? fileIds.length : 3;
          console.log("fileIds.length for " + this.countryName + " : " + this.fileIds.length);
          console.log("logInit for " + this.countryName + " : " + this.logInit);
          this.loadLog = function() {
            console.log("loadLog for " + this.countryName);
            return $http.get(window.location.protocol + "//" + window.location.host + "/logs", {
              params: {
                id: this.fileIds[this.fileIds.length - 1],
                country: this.countryName
              }
            });
          };
          this.getLog = function() {
            var _this = this;
            console.log("getLog");
            if (this.loadedLogs.length !== 0) {
              return this.loadedLogs.pop();
            } else if (this.fileIds.length !== 0) {
              this.loadLog().success(function(data, status, headers, config) {
                console.log("logInit for " + _this.countryName + " : " + _this.logInit);
                _this.loadedLogs.push(data.result);
                _this.fileIds.pop();
                _this.logInit--;
                if (_this.logInit === 0) {
                  console.log("DONE");
                  console.log(_this.countryIndex);
                  return $rootScope.$broadcast('country-finished-init', _this.countryIndex);
                }
              });
              return 1;
            } else {
              return 0;
            }
          };
          for (i = _i = 1; _i <= 3; i = ++_i) {
            this.getLog();
          }
          return this;
        }
      };
      return factory;
    }
  ]);

  srv.factory('Map', [
    '$rootScope', 'Country', function($rootScope, Country) {
      var service, shuffle;
      shuffle = function(array) {
        temp;
        index;
        var counter, index, temp;
        counter = array.length;
        while (counter--) {
          index = (Math.random() * counter) | 0;
          temp = array[counter];
          array[counter] = array[index];
          array[index] = temp;
          return array;
        }
      };
      service = {
        availableCountries: [],
        loadedCountries: [],
        current: [],
        map: [],
        countryIndex: 0
      };
      Country.getCountries().success(function(data, status, headers, config) {
        var callback, countries, current, i, _i, _results,
          _this = this;
        service.availableCountries = shuffle(data.countries);
        current = [100, 100];
        $rootScope.$on('country-init', function(event) {
          return service.countryIndex++;
        });
        $rootScope.$on('country-finished-init', function(event, countryIndex) {
          var i, _i, _results;
          _results = [];
          for (i = _i = -1; _i <= 1; i = ++_i) {
            console.log(100 + countryIndex);
            if (service.map[100 + countryIndex] == null) {
              service.map[100 + countryIndex] = [];
            }
            service.map[100 + countryIndex][100 + i] = service.loadedCountries[countryIndex].getLog();
            _results.push(console.log(service.map));
          }
          return _results;
        });
        _results = [];
        for (i = _i = 1; _i <= 3; i = ++_i) {
          countries = data.countries;
          callback = function(i) {
            var _this = this;
            return function(data, status, headers, config) {
              var country;
              country = countries[countries.length - i];
              return service.loadedCountries.push(Country.loadCountry(data.logs, country, service.countryIndex));
            };
          };
          _results.push(Country.getCountry(data.countries[data.countries.length - i]).success(callback(i)).error(function(data, status, headers, config) {
            return console.log(data);
          }));
        }
        return _results;
      });
      return service;
    }
  ]);

}).call(this);
